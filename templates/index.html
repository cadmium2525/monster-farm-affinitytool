<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>LMF 相性値調査ツール</title>
    <style>
        body { font-family: 'Arial', sans-serif; max-width: 800px; margin: auto; padding: 20px; background-color: #f4f7f9; }
        .container { display: flex; flex-direction: column; gap: 10px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        select:disabled { background-color: #e9ecef; }
        select, input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        button { padding: 10px 15px; border: none; border-radius: 4px; background-color: #007BFF; color: white; font-weight: bold; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        pre { background-color: #e9ecef; padding: 15px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; }
        h1, h2 { color: #333; text-align: center; }
        .mode-buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .monster-fields { display: flex; gap: 20px; }
        .field-group { flex: 1; display: flex; flex-direction: column; gap: 10px; }

        /* モーダルウィンドウのスタイル */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>LINEモンスターファーム 相性値調査ツール</h1>
    <button onclick="openModal()">マニュアル</button>
    <div class="mode-buttons">
        <button onclick="setMode('A_B')">A｜Bモード</button>
        <button onclick="setMode('A_new')">A｜新 調査モード</button>
        <button onclick="setMode('new_A')">新｜A 調査モード</button>
    </div>

    <form onsubmit="event.preventDefault(); calculate();">
        <div class="container">
            <h3>調査設定</h3>
            <div class="monster-fields">
                <div class="field-group">
                    <h4>主血統</h4>
                    <label>育成モンスター (Ch): <select id="ch"></select></label>
                    <label>父親 (F): <select id="f"></select></label>
                    <label>父方祖父 (Ff): <select id="ff"></select></label>
                    <label>父方祖母 (Fm): <select id="fm"></select></label>
                    <label>母親 (M): <select id="m"></select></label>
                    <label>母方祖父 (Mf): <select id="mf"></select></label>
                    <label>母方祖母 (Mm): <select id="mm"></select></label>
                </div>
                <div class="field-group">
                    <h4>副血統</h4>
                    <label>育成モンスター (Ch_sub): <select id="ch_sub"></select></label>
                    <label>父親 (F_sub): <select id="f_sub"></select></label>
                    <label>父方祖父 (Ff_sub): <select id="ff_sub"></select></label>
                    <label>父方祖母 (Fm_sub): <select id="fm_sub"></select></label>
                    <label>母親 (M_sub): <select id="m_sub"></select></label>
                    <label>母方祖父 (Mf_sub): <select id="mf_sub"></select></label>
                    <label>母方祖母 (Mm_sub): <select id="mm_sub"></select></label>
                </div>
            </div>
            <label>共通秘伝 III の数: <input type="number" id="af_iii" value="0" min="0"></label>
            <label>共通秘伝 II の数: <input type="number" id="af_ii" value="0" min="0"></label>
            <label>表示されたシンボル: 
                <select id="symbol">
                    <option value="">選択</option>
                    {% for symbol, _ in symbol_ranges.items() %}
                    <option value="{{ symbol }}">{{ symbol }}</option>
                    {% endfor %}
                </select>
            </label>
            <button type="submit">実行</button>
        </div>
    </form>
    
    <hr>
    
    <div class="container">
        <h3>現在の推定範囲の入力（続きから開始）<button onclick="resetRanges()">リセット</button></h3>
        <label for="current_a_new_min">A｜新 の現在の最小値: </label>
        <input type="number" id="current_a_new_min" value="">
        <label for="current_a_new_max">A｜新 の現在の最大値: </label>
        <input type="number" id="current_a_new_max" value="">

        <label for="current_new_a_min">新｜A の現在の最小値: </label>
        <input type="number" id="current_new_a_min" value="">
        <label for="current_new_a_max">新｜A の現在の最大値: </label>
        <input type="number" id="current_new_a_max" value="">
    </div>

    <div id="results"></div>

    <div id="manualModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h2>ツールの取扱説明書</h2>
            <h4>1. ツールの使い方</h4>
            <p><strong>基本操作:</strong></p>
            <ol>
                <li><strong>モード選択</strong>: 画面上部のボタンから、実行したいモードを選択します。</li>
                <li><strong>モンスター設定</strong>: 各モードで、主血統と副血統のスロットに適切なモンスターを設定します。</li>
                <li><strong>秘伝の数</strong>: 育成に使用した「共通秘伝Ⅱ」と「共通秘伝Ⅲ」の数を入力します。</li>
                <li><strong>シンボル選択</strong>: 育成完了時に表示されたシンボルマークを選択します。</li>
                <li><strong>実行</strong>: 「実行」ボタンを押すと、計算結果が表示されます。</li>
            </ol>
            <p><strong>調査モードの注意点:</strong></p>
            <ul>
                <li><strong>A｜新 調査モード</strong>: 父方祖父 (Ff) と 父方祖父 (Ff_sub) が「新モンスター」で固定されます。</li>
                <li><strong>新｜A 調査モード</strong>: 父親 (F)、父方祖父 (Ff)、父方祖母 (Fm) の主血統3体と、それぞれの副血統3体が「新モンスター」で固定されます。</li>
            </ul>
            
            <h4>2. ロジックの解説</h4>
            <p><strong>相性値の計算式（通常）:</strong></p>
            <p>合計相性値 = 主血統の相性値の合計 + 副血統の相性値の合計 + 共通秘伝ボーナス</p>
            <p>本ツールは既存モンスター間の相性値をデータベース化しており、上記計算式に基づき正確な合計値を算出します。</p>

            <p><strong>新モンスターの相性値の導出:</strong></p>
            <p>新モンスターはデータが未知のため、計算は逆算で行います。育成完了時のシンボルが示す合計相性値の範囲から、すでに計算済みの「既知の合計値」を差し引くことで、「新モンスター」が関わる未知の相性値の範囲を導き出します。</p>
            <p><strong>未知の相性値の範囲 = シンボルの範囲 - 既知の合計値</strong></p>

            <h4>3. 「現在の推定範囲」について</h4>
            <p>この機能は、複数回の試行で未知の相性値を絞り込むために使用します。新しい調査結果と前回の結果を比較し、両方の範囲が重なる部分のみを残すことで、より正確な相性値の範囲を推定します。調査を最初からやり直す場合は、「リセット」ボタンを押してください。</p>
            <p><strong>重要:</strong> 新｜A 調査モードは、A｜新 調査モードで得られた相性値を前提とします。必ずA｜新の調査を完了し、その値を相性表に手動で反映させてから、新｜Aの調査を開始してください。</p>
        </div>
    </div>

    <script>
        const allMonsters = {{ all_monsters | tojson }};
        const symbolRanges = {{ symbol_ranges | tojson }};
        const resultsDiv = document.getElementById('results');

        const selectIds = ['ch', 'f', 'ff', 'fm', 'm', 'mf', 'mm', 'ch_sub', 'f_sub', 'ff_sub', 'fm_sub', 'm_sub', 'mf_sub', 'mm_sub'];
        const rareMonsters = ['Phoenix', 'Mocchi'];
        const specialMonsters = ['新モンスター', 'レア'];

        function createOptions(selectElement) {
            selectElement.innerHTML = '';
            
            const sortableMonsters = allMonsters.filter(m => !specialMonsters.includes(m));
            sortableMonsters.sort();

            sortableMonsters.forEach(monster => {
                const option = document.createElement('option');
                option.value = monster;
                option.text = monster;
                if (rareMonsters.includes(monster)) {
                    option.text += ' (レア)';
                }
                selectElement.appendChild(option);
            });

            specialMonsters.forEach(monster => {
                const option = document.createElement('option');
                option.value = monster;
                option.text = monster;
                selectElement.appendChild(option);
            });
        }

        selectIds.forEach(id => {
            const select = document.getElementById(id);
            createOptions(select);
        });

        function removeEventListeners() {
            const chSelect = document.getElementById('ch');
            const fSelect = document.getElementById('f');
            const chSubSelect = document.getElementById('ch_sub');
            const fSubSelect = document.getElementById('f_sub');
            chSelect.onchange = null;
            fSelect.onchange = null;
            chSubSelect.onchange = null;
            fSubSelect.onchange = null;
        }

        function setMode(mode) {
            const A = 'Pixie';
            const New = '新モンスター';
            const Rare = 'レア';

            removeEventListeners();

            selectIds.forEach(id => {
                const select = document.getElementById(id);
                select.value = '';
                select.disabled = false;
            });

            if (mode === 'A_B') {
                // すべてのスロットを空にする
            } else if (mode === 'A_new') {
                document.getElementById('ch').value = A;
                document.getElementById('f').value = A;
                document.getElementById('ff').value = New;
                document.getElementById('ff_sub').value = New;
                document.getElementById('ch_sub').value = Rare;
                document.getElementById('f_sub').value = Rare;
                document.getElementById('fm_sub').value = Rare;
                document.getElementById('m_sub').value = Rare;
                document.getElementById('mf_sub').value = Rare;
                document.getElementById('mm_sub').value = Rare;
                
                document.getElementById('ff').disabled = true;
                document.getElementById('ff_sub').disabled = true;

                const chSelect = document.getElementById('ch');
                const fSelect = document.getElementById('f');
                const chSubSelect = document.getElementById('ch_sub');
                const fSubSelect = document.getElementById('f_sub');
                
                chSelect.onchange = () => { fSelect.value = chSelect.value; };
                fSelect.onchange = () => { chSelect.value = fSelect.value; };
                chSubSelect.onchange = () => { fSubSelect.value = chSubSelect.value; };
                fSubSelect.onchange = () => { chSubSelect.value = fSubSelect.value; };
                
            } else if (mode === 'new_A') {
                document.getElementById('f').value = New;
                document.getElementById('ff').value = New;
                document.getElementById('fm').value = New;
                document.getElementById('f_sub').value = New;
                document.getElementById('ff_sub').value = New;
                document.getElementById('fm_sub').value = New;
                
                document.getElementById('ch_sub').value = Rare;
                document.getElementById('m_sub').value = Rare;
                document.getElementById('mf_sub').value = Rare;
                document.getElementById('mm_sub').value = Rare;
                
                document.getElementById('f').disabled = true;
                document.getElementById('ff').disabled = true;
                document.getElementById('fm').disabled = true;
                document.getElementById('f_sub').disabled = true;
                document.getElementById('ff_sub').disabled = true;
                document.getElementById('fm_sub').disabled = true;
            }
        }

        function resetRanges() {
            document.getElementById('current_a_new_min').value = '';
            document.getElementById('current_a_new_max').value = '';
            document.getElementById('current_new_a_min').value = '';
            document.getElementById('current_new_a_max').value = '';
            resultsDiv.innerHTML = '';
        }
        
        function openModal() {
            document.getElementById('manualModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('manualModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('manualModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        async function calculate() {
            const af_ii_count = parseInt(document.getElementById('af_ii').value) || 0;
            const af_iii_count = parseInt(document.getElementById('af_iii').value) || 0;
            const af = (af_ii_count * 5) + (af_iii_count * 12.5);

            const data = {
                ch: document.getElementById('ch').value, f: document.getElementById('f').value, ff: document.getElementById('ff').value, fm: document.getElementById('fm').value, m: document.getElementById('m').value, mf: document.getElementById('mf').value, mm: document.getElementById('mm').value,
                ch_sub: document.getElementById('ch_sub').value, f_sub: document.getElementById('f_sub').value, ff_sub: document.getElementById('ff_sub').value, fm_sub: document.getElementById('fm_sub').value, m_sub: document.getElementById('m_sub').value, mf_sub: document.getElementById('mf_sub').value, mm_sub: document.getElementById('mm_sub').value,
                af: af,
                symbol: document.getElementById('symbol').value
            };
            
            const response = await fetch('/calculate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });
            const result = await response.json();

            if (result.all_known) {
                resultsDiv.innerHTML = `<h2>合計相性値: ${result.known_sum}</h2>`;
                return;
            }

            const knownSum = result.known_sum;
            const totalRange = symbolRanges[data.symbol];
            
            let unknownRange = [];
            let label = "";

            if (data.ff === '新モンスター' && data.ff_sub === '新モンスター') {
                unknownRange = [totalRange[0] - knownSum, totalRange[1] - knownSum];
                label = "A｜新";
                
                const currentMin = parseFloat(document.getElementById('current_a_new_min').value);
                const currentMax = parseFloat(document.getElementById('current_a_new_max').value);
                if (!isNaN(currentMin) && !isNaN(currentMax)) {
                    unknownRange = [Math.max(currentMin, unknownRange[0]), Math.min(currentMax, unknownRange[1])];
                }
                
                document.getElementById('current_a_new_min').value = unknownRange[0];
                document.getElementById('current_a_new_max').value = unknownRange[1];

                updateDisplay(unknownRange, label);
            } 
            else if (data.f === '新モンスター' && data.f_sub === '新モンスター' && data.ff === '新モンスター' && data.ff_sub === '新モンスター' && data.fm === '新モンスター' && data.fm_sub === '新モンスター') {
                 unknownRange = [totalRange[0] - knownSum, totalRange[1] - knownSum];
                 label = "新｜A + A｜新";
                 
                 const currentMin = parseFloat(document.getElementById('current_new_a_min').value);
                 const currentMax = parseFloat(document.getElementById('current_new_a_max').value);
                 if (!isNaN(currentMin) && !isNaN(currentMax)) {
                    unknownRange = [Math.max(currentMin, unknownRange[0]), Math.min(currentMax, unknownRange[1])];
                 }
                 
                 document.getElementById('current_new_a_min').value = unknownRange[0];
                 document.getElementById('current_new_a_max').value = unknownRange[1];
                 
                 updateDisplay(unknownRange, label);
            }
            else {
                 resultsDiv.innerHTML = `<p>この組み合わせでは計算できません。</p>`;
                 return;
            }
            
        }

        function updateDisplay(range, label) {
            resultsDiv.innerHTML = `
                <h2>最新の調査結果</h2>
                <p>推定される **${label}** の範囲: [${range[0]}, ${range[1]}]</p>
            `;
        }
    </script>
</body>
</html>